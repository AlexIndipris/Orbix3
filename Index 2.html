<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVENTOS | Plataforma de Gestión de Eventos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Eliminamos la configuración de color personalizada para usar clases estándar de Tailwind */
        
        body {
            background-color: #f7f7f7;
            font-family: sans-serif;
        }
        .container-card {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Estilos para el botón de archivo (usando pink-500 y pink-400) */
        .file-input-custom::-webkit-file-upload-button {
            color: white;
            background-color: #EC4899; /* pink-500 */
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 1rem;
            cursor: pointer;
            transition: background-color 150ms ease-in-out;
        }
        .file-input-custom::-webkit-file-upload-button:hover {
            background-color: #F472B6; /* pink-400 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <nav class="bg-pink-500 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="fa-solid fa-cube text-white text-2xl"></span>
                        <span class="text-xl font-bold tracking-wide text-white">EventOS</span>
                        <span class="text-xs text-gray-200 normal">v2.0</span>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div id="nav-links" class="ml-10 flex items-baseline space-x-4">
                        </div>
                </div>
                <div class="flex items-center">
                    <span id="user-display" class="text-sm text-gray-100 hidden mr-4">Hola, Usuario</span>
                    <button id="btn-login" class="bg-rose-600 hover:bg-pink-400 text-white font-semibold py-1 px-3 rounded text-sm hidden">
                        Login
                    </button>
                    <button id="btn-logout" onclick="handleLogout()" class="bg-rose-600 hover:bg-pink-400 text-white font-semibold py-1 px-3 rounded text-sm hidden">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="p-4">
        
        <section id="login" class="hidden">
            <div class="container-card p-6 md:p-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Iniciar Sesión</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                        <input type="email" id="email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                        <input type="password" id="password" name="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <button type="submit" class="w-full bg-rose-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-pink-400 transition duration-150">
                        Acceder
                    </button>
                    <p class="mt-4 text-center">
                        <a href="#" onclick="handlePasswordResetPrompt(event)" class="text-sm text-rose-600 hover:underline">¿Olvidaste tu contraseña?</a>
                    </p>
                </form>
            </div>
        </section>

        <section id="registro" class="hidden">
            <div class="container-card p-6 md:p-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Solicitud de Acceso</h2>
                 <p class="text-center text-gray-600 mb-6">Completa este formulario para solicitar acceso a la plataforma.</p>
                <form id="registro-form" onsubmit="handleRegister(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <input type="text" id="nombre" name="nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="apellido" class="block text-sm font-medium text-gray-700">Apellido</label>
                            <input type="text" id="apellido" name="apellido" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input type="email" id="reg-email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                         <div class="md:col-span-2">
                            <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                            <input type="tel" id="telefono" name="telefono" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Ej: +52 55 1234 5678" required>
                        </div>
                        <div>
                            <label for="reg-password" class="block text-sm font-medium text-gray-700">Contraseña (Mínimo 8 caracteres)</label>
                            <input type="password" id="reg-password" name="reg-password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required minlength="8">
                        </div>
                        <div>
                            <label for="reg-password-confirm" class="block text-sm font-medium text-gray-700">Confirmar Contraseña</label>
                            <input type="password" id="reg-password-confirm" name="reg-password-confirm" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required minlength="8">
                        </div>
                    </div>
                    
                    <div id="reg-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden" role="alert">
                        </div>

                    <button type="submit" class="w-full mt-6 bg-rose-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-pink-400 transition duration-150">
                        Enviar Solicitud
                    </button>
                    
                     <p class="mt-4 text-center text-sm text-gray-600">
                        ¿Ya tienes cuenta? 
                        <a href="#" onclick="showSection('login')" class="font-semibold text-rose-600 hover:underline">Iniciar Sesión</a>
                    </p>
                </form>
            </div>
        </section>

        <section id="dashboard" class="hidden">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Dashboard</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p class="text-lg text-gray-600">Bienvenido a tu panel de control. Aquí podrás ver el estado de tus viajes y autorizaciones pendientes.</p>
                        <div id="dashboard-content" class="mt-4">
                            <div class="bg-gray-100 p-4 rounded text-gray-500">
                                <p>Cargando datos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <section id="solicitud" class="hidden">
            <div class="container-card p-6 md:p-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Solicitud de Viaje</h2>
                
                <div id="request-message" class="p-3 bg-emerald-100 border border-emerald-400 text-emerald-700 rounded hidden mb-4" role="alert">
                    </div>

                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" id="form-tabs">
                        <button type="button" data-tab="datos-generales" class="tab-button border-b-2 border-pink-500 text-pink-500 whitespace-nowrap py-4 px-1 text-sm font-medium">Generales</button>
                        <button type="button" data-tab="destino-fechas" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Destino y Fechas</button>
                        <button type="button" data-tab="transporte-hotel" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Transporte/Hotel</button>
                        <button type="button" data-tab="viajeros" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Viajeros</button>
                    </nav>
                </div>

                <form id="solicitud-form" onsubmit="handleNewRequest(event)" class="mt-6">
                    
                    <div id="datos-generales" class="tab-content">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">Generales</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-nombre-solicitud" class="block text-sm font-medium text-gray-700">Nombre de la Solicitud (Título)</label>
                                <input type="text" id="req-nombre-solicitud" name="nombre_solicitud" class="w-full border p-2 rounded" placeholder="Ej: Viaje de Ventas Q4" required>
                            </div>
                            <div>
                                <label for="req-tipo-solicitud" class="block text-sm font-medium text-gray-700">Tipo de Solicitud</label>
                                <select id="req-tipo-solicitud" name="tipo_solicitud" class="w-full border p-2 rounded" required>
                                    <option value="">Seleccione...</option>
                                    <option value="nueva_cotizacion">Nueva Cotización</option>
                                    <option value="solicitud_aprobada">Solicitud de Reserva (Aprobada)</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Motivo del Viaje</label>
                                <div class="flex flex-wrap gap-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="tipo_viaje" value="negocios" class="form-radio text-pink-500 border-pink-500 focus:ring-pink-500" required>
                                        <span class="ml-2">Negocios (Ventas, Mkt)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="tipo_viaje" value="capacitacion" class="form-radio text-pink-500 border-pink-500 focus:ring-pink-500">
                                        <span class="ml-2">Capacitación / Evento</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="tipo_viaje" value="operaciones" class="form-radio text-pink-500 border-pink-500 focus:ring-pink-500">
                                        <span class="ml-2">Operaciones / Logística</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="tipo_viaje" value="otro" class="form-radio text-pink-500 border-pink-500 focus:ring-pink-500">
                                        <span class="ml-2">Otro</span>
                                    </label>
                                </div>
                                <input type="text" id="req-otro-tipo-viaje" name="otro_tipo_viaje" class="w-full border p-2 rounded mt-2 hidden" placeholder="Especifique el motivo del viaje" disabled>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="req-notas-solicitante" class="block text-sm font-medium text-gray-700">Notas Adicionales / Requisitos Especiales</label>
                                <textarea id="req-notas-solicitante" name="notas_solicitante" rows="3" class="w-full border p-2 rounded" placeholder="Ej: Se requiere asiento en pasillo, o prefiero aerolínea X."></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="destino-fechas" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">Destino y Fechas</h3>

                        <div class="mb-4">
                            <label for="req-descripcion-viaje" class="block text-sm font-medium text-gray-700">¿A dónde será el viaje? (Descripción general)</label>
                            <input type="text" id="req-descripcion-viaje" name="descripcion_viaje" class="w-full border p-2 rounded" placeholder="EJ: Visita a clientes en Monterrey" required>
                        </div>
                        
                        <h4 class="font-bold text-gray-800 mt-6 mb-2">Destino Nacional</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-ciudad-nacional" class="block text-sm font-medium text-gray-700">Ciudad de Destino (Nacional)</label>
                                <input type="text" id="req-ciudad-nacional" name="ciudad_destino_nacional" class="w-full border p-2 rounded" placeholder="Monterrey">
                            </div>
                            <div>
                                <label for="req-estado-nacional" class="block text-sm font-medium text-gray-700">Estado de Destino</label>
                                <input type="text" id="req-estado-nacional" name="estado_destino_nacional" class="w-full border p-2 rounded" placeholder="Nuevo León">
                            </div>
                        </div>
                        
                        <h4 class="font-bold text-gray-800 mt-6 mb-2">Destino Internacional (si aplica)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-ciudad-extranjero" class="block text-sm font-medium text-gray-700">Ciudad de Destino en el Extranjero</label>
                                <input type="text" id="req-ciudad-extranjero" name="ciudad_destino_extranjero" class="w-full border p-2 rounded" placeholder="Miami">
                            </div>
                            <div>
                                <label for="req-pais-extranjero" class="block text-sm font-medium text-gray-700">País de Destino en el Extranjero</label>
                                <input type="text" id="req-pais-extranjero" name="pais_destino_extranjero" class="w-full border p-2 rounded" placeholder="EE. UU.">
                            </div>
                        </div>

                        <h4 class="font-bold text-gray-800 mt-6 mb-2">Fechas del Viaje</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-fecha-inicio" class="block text-sm font-medium text-gray-700">Fecha de inicio del viaje</label>
                                <input type="date" id="req-fecha-inicio" name="fecha_inicio_viaje" class="w-full border p-2 rounded" required>
                            </div>
                            <div>
                                <label for="req-fecha-fin" class="block text-sm font-medium text-gray-700">Fecha de finalización del viaje</label>
                                <input type="date" id="req-fecha-fin" name="fecha_fin_viaje" class="w-full border p-2 rounded" required>
                            </div>
                        </div>
                    </div>

                    <div id="transporte-hotel" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">Transporte</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-lugar-partida" class="block text-sm font-medium text-gray-700">Lugar de Partida (Ciudad)</label>
                                <input type="text" id="req-lugar-partida" name="lugar_partida" class="w-full border p-2 rounded" placeholder="Ej: CDMX" required>
                            </div>
                            <div>
                                <label for="req-lugar-llegada" class="block text-sm font-medium text-gray-700">Lugar de Llegada (Ciudad)</label>
                                <input type="text" id="req-lugar-llegada" name="lugar_llegada" class="w-full border p-2 rounded" placeholder="Ej: MTY" required>
                            </div>
                            <div>
                                <label for="req-terminal-salida" class="block text-sm font-medium text-gray-700">Terminal de Salida (Aeropuerto/Central)</label>
                                <input type="text" id="req-terminal-salida" name="terminal_salida" class="w-full border p-2 rounded" placeholder="Ej: MEX, AICM T2">
                            </div>
                            <div>
                                <label for="req-terminal-llegada" class="block text-sm font-medium text-gray-700">Terminal de Llegada (Aeropuerto/Central)</label>
                                <input type="text" id="req-terminal-llegada" name="terminal_llegada" class="w-full border p-2 rounded" placeholder="Ej: MTY, Terminal A">
                            </div>
                            <div>
                                <label for="req-hora-salida-ida" class="block text-sm font-medium text-gray-700">Hora de Salida (Ida)</label>
                                <input type="time" id="req-hora-salida-ida" name="hora_salida_ida" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label for="req-hora-salida-regreso" class="block text-sm font-medium text-gray-700">Hora de Salida (Regreso)</label>
                                <input type="time" id="req-hora-salida-regreso" name="hora_salida_regreso" class="w-full border p-2 rounded">
                            </div>
                            
                            <div class="md:col-span-2 flex items-center mt-2">
                                <input type="checkbox" id="req-equipaje" name="necesidad_equipaje" class="h-4 w-4 text-pink-500 border-pink-500 rounded focus:ring-pink-500">
                                <label for="req-equipaje" class="ml-2 block text-sm font-medium text-gray-700">Se requiere documentar equipaje.</label>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold mb-4 mt-8 text-gray-900">Hospedaje</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="req-fecha-entrada-hotel" class="block text-sm font-medium text-gray-700">Fecha de Entrada al Hotel</label>
                                <input type="date" id="req-fecha-entrada-hotel" name="fecha_entrada_hotel" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label for="req-fecha-salida-hotel" class="block text-sm font-medium text-gray-700">Fecha de Salida del Hotel</label>
                                <input type="date" id="req-fecha-salida-hotel" name="fecha_salida_hotel" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label for="req-habitaciones" class="block text-sm font-medium text-gray-700">Cantidad de Habitaciones</label>
                                <select id="req-habitaciones" name="cantidad_habitaciones" class="w-full border p-2 rounded" required>
                                    <option value="1">1 Habitación</option>
                                    <option value="2">2 Habitaciones</option>
                                    <option value="3">3 Habitaciones</option>
                                </select>
                            </div>
                            <div>
                                <label for="req-personas-h1" class="block text-sm font-medium text-gray-700">Personas en Habitación 1</label>
                                <input type="number" id="req-personas-h1" name="personas_habitacion_1" class="w-full border p-2 rounded" min="1" max="4" value="1" required>
                            </div>
                             <div id="habitacion-2-field" class="hidden">
                                <label for="req-personas-h2" class="block text-sm font-medium text-gray-700">Personas en Habitación 2</label>
                                <input type="number" id="req-personas-h2" name="personas_habitacion_2" class="w-full border p-2 rounded" min="0" max="4" value="0">
                            </div>
                        </div>
                    </div>

                    <div id="viajeros" class="tab-content hidden">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900">Viajeros</h3>
                        
                        <div class="mb-4">
                            <label for="req-cantidad-personas" class="block text-sm font-medium text-gray-700">Cantidad de Viajeros (Total)</label>
                            <input type="number" id="req-cantidad-personas" name="cantidad_personas" class="w-full border p-2 rounded" min="1" max="4" value="1" required>
                        </div>
                        
                        <div id="viajeros-container" class="space-y-4">
                            <div class="p-4 border border-pink-500 rounded-md bg-pink-500/10">
                                <h4 class="font-bold text-gray-800">Viajero 1 (Solicitante)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label for="req-nombre-v1" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                        <input type="text" id="req-nombre-v1" name="nombre_viajero_1" class="w-full border p-2 rounded" placeholder="Nombre completo" required>
                                    </div>
                                    <div>
                                        <label for="req-identificacion-file-v1" class="block text-sm font-medium text-gray-700">Identificación (Subir PDF/Imagen)</label>
                                        <input type="file" id="req-identificacion-file-v1" name="identificacion_file_v1" accept=".pdf,.png,.jpg,.jpeg" class="w-full border p-2 rounded text-sm file-input-custom" required>
                                        <p class="text-xs text-gray-500 mt-1">Sube DNI o Pasaporte (PDF, PNG o JPG).</p>
                                    </div>
                                </div>
                            </div>
                            </div>
                    </div>

                    <button type="submit" id="btn-submit-request" class="w-full mt-8 bg-rose-600 text-white py-3 px-4 rounded-md font-bold hover:bg-pink-400 transition duration-150">
                        Enviar Solicitud de Viaje
                    </button>
                </form>

            </div>
        </section>

    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ----------------------------------------------------------------------
        // 1. CARGA DEL SDK DE SUPABASE Y CONFIGURACIÓN
        // ----------------------------------------------------------------------
        
        // **IMPORTANTE: UTILIZA LAS CLAVES DE TU NUEVO PROYECTO**
        const SUPABASE_URL = 'https://rfsznydtcxeeftradqhz.supabase.co'; // Reemplaza con tu nueva URL
        const SUPABASE_ANON_KEY = 'sb_publishable_2dkLxpVJ5dF1E01_P2z-LA_4GVs39mf'; // Reemplaza con tu nueva Clave Anónima
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const sections = ['login', 'registro', 'dashboard', 'solicitud']; 
        let currentUser = null;
        let currentTab = 'datos-generales';

        document.addEventListener('DOMContentLoaded', () => {
             checkUserSession(); 
        });

        // ----------------------------------------------------------------------
        // 2. CORE DE AUTENTICACIÓN Y ROLES
        // ----------------------------------------------------------------------

        async function checkUserSession() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (user) {
                currentUser = user;
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('rol, nombre, empresa_id, empresas(nombre)') 
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    user.role = profile.rol;
                    user.name = profile.nombre || user.email.split('@')[0];
                    user.empresa = profile.empresas ? profile.empresas.nombre : 'N/A';
                    user.empresa_id = profile.empresa_id; 
                } else {
                    user.role = 'empleado'; 
                    user.name = user.email.split('@')[0];
                    user.empresa = 'N/A';
                    user.empresa_id = null;
                }
                
                updateNavbarUser(user);
                
                if (user.role === 'admin' || user.role === 'coordinador') {
                    showSection('dashboard');
                    loadDashboardData(); 
                } else {
                    showSection('solicitud'); 
                }
                
                initializeFormListeners();
                updateViajerosFields(); 
                
            } else {
                currentUser = null;
                updateNavbarUser(null);
                showSection('registro'); 
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                alert('Error de Login: ' + error.message);
            } else {
                await checkUserSession(); 
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            showSection('login');
            updateNavbarUser(null);
        }
        
        // ----------------------------------------------------------------------
        // 3. HANDLER DEL FORMULARIO DE REGISTRO
        // ----------------------------------------------------------------------

        async function handleRegister(e) {
            e.preventDefault();
            const form = document.getElementById('registro-form');
            const messageDiv = document.getElementById('reg-message');
            messageDiv.classList.add('hidden'); 
            messageDiv.classList.remove('text-emerald-700', 'bg-emerald-100', 'border-emerald-400'); 
            messageDiv.classList.add('text-red-700', 'bg-red-100', 'border-red-400');

            const nombre = form['nombre'].value;
            const apellido = form['apellido'].value;
            const email = form['email'].value;
            const telefono = form['telefono'].value;
            const password = form['reg-password'].value;
            const passwordConfirm = form['reg-password-confirm'].value;
            const full_name = `${nombre} ${apellido}`;

            // 1. Validaciones de contraseña
            if (password !== passwordConfirm) {
                messageDiv.innerText = '⚠️ Las contraseñas no coinciden. Por favor, revísalas.';
                messageDiv.classList.remove('hidden');
                return;
            }
            if (password.length < 8) {
                messageDiv.innerText = '⚠️ La contraseña debe tener al menos 8 caracteres.';
                messageDiv.classList.remove('hidden');
                return;
            }

            // PASO 2: CREAR USUARIO EN AUTH
            const { error: authError } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { 
                        nombre: full_name, 
                        telefono: telefono
                    } 
                }
            });

            if (authError) {
                messageDiv.innerText = `Error de Registro: ${authError.message}. ¿El correo ya existe?`;
                messageDiv.classList.remove('hidden');
                return;
            }

            // Éxito:
            messageDiv.classList.remove('text-red-700', 'bg-red-100', 'border-red-400');
            messageDiv.classList.add('text-emerald-700', 'bg-emerald-100', 'border-emerald-400'); 
            messageDiv.innerText = '✅ ¡Solicitud de acceso exitosa! Revisa tu correo para confirmar la cuenta. Luego inicia sesión.';
            messageDiv.classList.remove('hidden');
            form.reset();
        }

        // ----------------------------------------------------------------------
        // 4. FUNCIONES DE OLVIDÉ MI CONTRASEÑA
        // ----------------------------------------------------------------------
        
        function handlePasswordResetPrompt(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email');
            
            const email = emailInput.value.trim();

            const promptText = email 
                ? `Ingresa tu correo si deseas restablecer la contraseña (actual: ${email}):`
                : `Por favor, ingresa el correo electrónico asociado a tu cuenta para restablecer tu contraseña:`;

            const userEmail = prompt(promptText, email || '');

            if (userEmail) {
                handlePasswordReset(userEmail);
            }
        }

        async function handlePasswordReset(email) {
            if (!email) return;

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                // Asegúrate de que esta URL sea correcta para tu entorno de producción
                redirectTo: 'https://indipris.com/orbix/' 
            });

            if (error) {
                alert('❌ Error al enviar el correo de restablecimiento: ' + error.message);
                console.error("Password Reset Error:", error);
            } else {
                alert(`✅ Instrucciones de restablecimiento enviadas a ${email}. Por favor, revisa tu bandeja de entrada.`);
            }
        }

        // ----------------------------------------------------------------------
        // 5. LÓGICA DEL DASHBOARD Y UI
        // ----------------------------------------------------------------------
        
        async function loadDashboardData() {
            if (!currentUser) return;
            // Aquí se cargarán los documentos o solicitudes de viaje.
            const dashboardContent = document.getElementById('dashboard-content');
            dashboardContent.innerHTML = `<p class="text-lg text-gray-600">Cargando datos para el rol: ${currentUser.role} de la empresa: ${currentUser.empresa}...</p>`;
            
            // Ejemplo de carga:
            const { data: solicitudes, error } = await supabaseClient
                .from('solicitudes_viaje')
                .select('*')
                .eq('user_id', currentUser.id) 
                .order('created_at', { ascending: false });
                
            if (error) {
                 dashboardContent.innerHTML = `<p class="text-red-500">Error al cargar solicitudes: ${error.message}</p>`;
                 return;
            }

            if (solicitudes.length > 0) {
                 dashboardContent.innerHTML = `<h4 class="font-bold mt-4">Tus Últimas Solicitudes (${solicitudes.length})</h4>`;
                 solicitudes.slice(0, 5).forEach(sol => {
                     dashboardContent.innerHTML += `<div class="mt-2 p-3 border rounded">
                         <p class="font-semibold">${sol.nombre_solicitud} - <span class="text-sm text-gray-500">${sol.created_at.substring(0, 10)}</span></p>
                         <p class="text-sm">Estado: <span class="capitalize font-medium text-blue-600">${sol.status}</span> | Destino: ${sol.ciudad_destino_nacional || sol.ciudad_destino_extranjero}</p>
                     </div>`;
                 });
            } else {
                 dashboardContent.innerHTML = `<p class="text-gray-500 mt-4">No tienes solicitudes de viaje registradas.</p>`;
            }
        }
        
        function showSection(id) {
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function updateNavbarUser(user) {
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            const userDisplay = document.getElementById('user-display');
            const navLinks = document.getElementById('nav-links');

            navLinks.innerHTML = '';

            if (user) {
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
                userDisplay.classList.remove('hidden');
                userDisplay.innerText = `Hola, ${user.name}`;
                
                if(user.role === 'admin' || user.role === 'coordinador') {
                    addNavLink('Gestión', 'dashboard');
                    addNavLink('Autorizaciones', 'solicitud'); 
                } else {
                    addNavLink('Solicitar Viaje', 'solicitud');
                    addNavLink('Mis Viajes', 'dashboard'); 
                }
            } else {
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
                userDisplay.classList.add('hidden');
                
                addNavLink('Registro', 'registro');
                addNavLink('Login', 'login');
            }
        }

        function addNavLink(text, sectionId) {
            const link = document.createElement('a');
            link.innerText = text;
            link.onclick = (e) => {
                e.preventDefault();
                showSection(sectionId);
                if (sectionId === 'solicitud') {
                    setActiveTab('datos-generales');
                }
            };
            // Links de navegación: texto en gris-100, hover en pink-400
            link.className = "text-gray-100 hover:bg-pink-400 px-3 py-2 rounded-md text-sm font-medium cursor-pointer";
            document.getElementById('nav-links').appendChild(link);
        }

        // ----------------------------------------------------------------------
        // 6. LÓGICA DEL FORMULARIO DE SOLICITUD DE VIAJE (VALIDACIÓN Y PESTAÑAS)
        // ----------------------------------------------------------------------
        
        /**
         * Verifica si todos los campos requeridos en el contenedor dado están llenos.
         * @param {HTMLElement} container - El elemento que contiene los campos a validar.
         * @returns {boolean} True si todos los campos requeridos están llenos.
         */
        function validateTab(container) {
            let isValid = true;
            container.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
                if (field.offsetParent === null && field.id !== 'req-otro-tipo-viaje') return; 
                
                if (field.type === 'radio') {
                    const radioGroup = document.querySelector(`input[name="${field.name}"]:checked`);
                    if (!radioGroup) {
                        isValid = false;
                    }
                } else if (field.type === 'file') {
                    if (field.files.length === 0) {
                        isValid = false;
                        field.classList.add('border-red-500');
                    } else {
                        field.classList.remove('border-red-500');
                    }
                } else if (!field.value.trim() && !field.disabled) {
                    isValid = false;
                    field.classList.add('border-red-500');
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            return isValid;
        }

        function setActiveTab(targetTabId) {
            currentTab = targetTabId;
            const tabsContainer = document.getElementById('form-tabs');
            const tabContents = document.querySelectorAll('.tab-content');

            // Actualizar botones (usando pink-500)
            tabsContainer.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-pink-500', 'text-pink-500');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                if (btn.getAttribute('data-tab') === targetTabId) {
                    btn.classList.add('border-pink-500', 'text-pink-500');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                }
            });

            // Mostrar contenido
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(targetTabId).classList.remove('hidden');
        }

        function initializeFormListeners() {
            if (!currentUser || !document.getElementById('form-tabs')) return;
            
            // 6.1. Manejo de Pestañas con Validación
            const tabsContainer = document.getElementById('form-tabs');

            tabsContainer.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetTabId = button.getAttribute('data-tab');
                    const currentTabContent = document.getElementById(currentTab);
                    
                    if (targetTabId !== currentTab) {
                        if (!validateTab(currentTabContent)) {
                            e.preventDefault(); 
                            const firstErrorField = currentTabContent.querySelector('.border-red-500');
                            if (firstErrorField) {
                                firstErrorField.focus();
                            }
                            alert(`Por favor, complete todos los campos requeridos en la pestaña "${currentTabContent.querySelector('h3').innerText}" antes de continuar.`);
                            return; 
                        }
                    }
                    
                    setActiveTab(targetTabId);
                });
            });

            // 6.2. Campo "Otro Tipo de Viaje"
            document.querySelectorAll('input[name="tipo_viaje"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const otroInput = document.getElementById('req-otro-tipo-viaje');
                    const isOtro = e.target.value === 'otro';
                    
                    otroInput.disabled = !isOtro;
                    otroInput.required = isOtro;
                    
                    if (isOtro) {
                         otroInput.classList.remove('hidden');
                    } else {
                        otroInput.value = '';
                        otroInput.classList.add('hidden');
                    }
                });
            });
            
            // 6.3. Campos de Habitaciones
            const numHabitacionesInput = document.getElementById('req-habitaciones');
            const habitacion2Field = document.getElementById('habitacion-2-field');
            if (numHabitacionesInput) {
                numHabitacionesInput.addEventListener('input', () => {
                    const num = parseInt(numHabitacionesInput.value);
                    const personasH2 = document.getElementById('req-personas-h2');
                    
                    if (num >= 2) {
                        habitacion2Field.classList.remove('hidden');
                        personasH2.required = true;
                    } else {
                        habitacion2Field.classList.add('hidden');
                        personasH2.value = 0; 
                        personasH2.required = false;
                    }
                });
            }

            // 6.4. Generación de campos de Viajeros
            document.getElementById('req-cantidad-personas').addEventListener('input', updateViajerosFields);
            
            // 6.5. Precargar el nombre del solicitante (Viajero 1)
            if (currentUser && currentUser.name) {
                document.getElementById('req-nombre-v1').value = currentUser.name;
            }
        }
        
        // Función para actualizar los campos de Viajeros (2, 3, 4) dinámicamente
        function updateViajerosFields() {
            const container = document.getElementById('viajeros-container');
            const numViajerosInput = document.getElementById('req-cantidad-personas');
            if (!container || !numViajerosInput) return;

            const numViajeros = parseInt(numViajerosInput.value);
            
            // Limpiar viajeros adicionales (empezamos a partir de V2)
            for (let i = 2; i <= 4; i++) {
                const field = document.getElementById(`viajero-${i}-inputs`);
                if (field) field.remove();
            }

            // Generar viajeros adicionales
            for (let i = 2; i <= numViajeros; i++) {
                const html = `
                    <div id="viajero-${i}-inputs" class="p-4 border rounded-md">
                        <h4 class="font-bold text-gray-800">Viajero ${i}</h4>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="req-nombre-v${i}" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                <input type="text" id="req-nombre-v${i}" name="nombre_viajero_${i}" class="w-full border p-2 rounded" placeholder="Nombre completo de Viajero ${i}" required>
                            </div>
                            <div>
                                <label for="req-id-v${i}" class="block text-sm font-medium text-gray-700">Identificación (DNI/Pasaporte)</label>
                                <input type="text" id="req-id-v${i}" name="identificacion_viajero_${i}" class="w-full border p-2 rounded" placeholder="ID de Viajero ${i}" required>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
             const fileInputV1 = document.getElementById('req-identificacion-file-v1');
             if (fileInputV1) {
                fileInputV1.required = true;
             }
        }

        // Función principal para el envío de la solicitud a Supabase
        async function handleNewRequest(e) {
            e.preventDefault();
            
            // 1. Validación Final 
            const currentTabContent = document.getElementById(currentTab);
            if (!validateTab(currentTabContent)) {
                 alert(`Por favor, complete todos los campos requeridos en la pestaña "${currentTabContent.querySelector('h3').innerText}" antes de enviar.`);
                 setActiveTab(currentTab); 
                 return;
            }
            
            // 2. Validación de Carga de Archivo (Viajero 1)
            const fileInputV1 = document.getElementById('req-identificacion-file-v1');
            if (fileInputV1 && fileInputV1.files.length === 0) {
                 alert("Por favor, suba el archivo de identificación del Viajero 1.");
                 setActiveTab('viajeros');
                 return;
            }
            
            if (!currentUser || !currentUser.id) {
                alert("Error: No se pudo obtener la información de su usuario. Intente iniciar sesión de nuevo.");
                return;
            }
            
            const form = document.getElementById('solicitud-form');
            const messageDiv = document.getElementById('request-message');
            messageDiv.classList.add('hidden');
            document.getElementById('btn-submit-request').disabled = true;

            try {
                const formData = new FormData(form);
                
                // **PASO 1.1: Subir Archivo de Identificación del Viajero 1**
                const identificacionFileV1 = fileInputV1.files[0];
                let fileUrlV1 = null;

                if (identificacionFileV1) {
                    const filePath = `${currentUser.id}/${Date.now()}-${identificacionFileV1.name.replace(/\s/g, '_')}`;
                    
                    const { error: uploadError } = await supabaseClient.storage
                        .from('identificaciones-viajes') 
                        .upload(filePath, identificacionFileV1, {
                            cacheControl: '3600',
                            upsert: false 
                        });

                    if (uploadError) {
                        throw new Error(`Error al subir el archivo de identificación: ${uploadError.message}`);
                    }
                    
                    fileUrlV1 = filePath; 
                }
                
                // 2. Recolección de Datos 
                const dataToInsert = {
                    user_id: currentUser.id,
                    empresa_id: currentUser.empresa_id, 

                    // General
                    nombre_solicitud: formData.get('nombre_solicitud'),
                    tipo_solicitud: formData.get('tipo_solicitud'),
                    tipo_viaje: formData.get('tipo_viaje'),
                    otro_tipo_viaje: formData.get('tipo_viaje') === 'otro' ? formData.get('otro_tipo_viaje') : null,
                    notas_solicitante: formData.get('notas_solicitante'),
                    
                    // Destino
                    descripcion_viaje: formData.get('descripcion_viaje'),
                    ciudad_destino_nacional: formData.get('ciudad_destino_nacional') || null,
                    estado_destino_nacional: formData.get('estado_destino_nacional') || null,
                    ciudad_destino_extranjero: formData.get('ciudad_destino_extranjero') || null,
                    pais_destino_extranjero: formData.get('pais_destino_extranjero') || null,
                    fecha_inicio_viaje: formData.get('fecha_inicio_viaje'),
                    fecha_fin_viaje: formData.get('fecha_fin_viaje'),

                    // Transporte
                    lugar_partida: formData.get('lugar_partida'),
                    lugar_llegada: formData.get('lugar_llegada'),
                    terminal_salida: formData.get('terminal_salida') || null,
                    terminal_llegada: formData.get('terminal_llegada') || null,
                    hora_salida_ida: formData.get('hora_salida_ida') || null,
                    hora_salida_regreso: formData.get('hora_salida_regreso') || null,
                    necesidad_equipaje: formData.get('necesidad_equipaje') === 'on', 

                    // Hospedaje
                    fecha_entrada_hotel: formData.get('fecha_entrada_hotel') || null,
                    fecha_salida_hotel: formData.get('fecha_salida_hotel') || null,
                    cantidad_habitaciones: parseInt(formData.get('cantidad_habitaciones') || 0),
                    personas_habitacion_1: parseInt(formData.get('personas_habitacion_1') || 0),
                    personas_habitacion_2: parseInt(formData.get('personas_habitacion_2') || 0),

                    // Viajeros 
                    cantidad_personas: parseInt(formData.get('cantidad_personas') || 1),
                    nombre_viajero_1: formData.get('nombre_viajero_1'),
                    identificacion_viajero_1: fileUrlV1, 
                    nombre_viajero_2: formData.get('nombre_viajero_2') || null,
                    identificacion_viajero_2: formData.get('identificacion_viajero_2') || null,
                    nombre_viajero_3: formData.get('nombre_viajero_3') || null,
                    identificacion_viajero_3: formData.get('identificacion_viajero_3') || null,
                    nombre_viajero_4: formData.get('nombre_viajero_4') || null,
                    identificacion_viajero_4: formData.get('identificacion_viajero_4') || null,
                    
                    // Metadatos
                    status: 'pendiente',
                    solicitado_por_nombre: currentUser.name || currentUser.email
                };
                
                // Cálculo de noches 
                if (dataToInsert.fecha_entrada_hotel && dataToInsert.fecha_salida_hotel) {
                    const inicio = new Date(dataToInsert.fecha_entrada_hotel);
                    const fin = new Date(dataToInsert.fecha_salida_hotel);
                    const diffTime = Math.abs(fin - inicio);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    dataToInsert.cantidad_noches = diffDays;
                } else {
                    dataToInsert.cantidad_noches = 0;
                }

                // 3. Insertar en Supabase (Tabla solicitudes_viaje)
                const { data, error } = await supabaseClient
                    .from('solicitudes_viaje')
                    .insert([dataToInsert])
                    .select(); 

                if (error) {
                    throw new Error(error.message);
                }

                // 4. Éxito
                messageDiv.innerText = `✅ ¡Solicitud enviada! ID: ${data[0].id}. Un agente te contactará pronto.`;
                messageDiv.classList.remove('hidden', 'text-red-700', 'bg-red-100', 'border-red-400');
                messageDiv.classList.add('text-emerald-700', 'bg-emerald-100', 'border-emerald-400');
                form.reset();
                updateViajerosFields(); 
                setActiveTab('datos-generales'); 
                
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 7000);

            } catch (error) {
                console.error("Error al enviar solicitud:", error);
                messageDiv.innerText = `❌ Error al enviar la solicitud: ${error.message}. Por favor, verifique su conexión y permisos.`;
                messageDiv.classList.remove('hidden', 'text-emerald-700', 'bg-emerald-100', 'border-emerald-400');
                messageDiv.classList.add('text-red-700', 'bg-red-100', 'border-red-400');
            } finally {
                document.getElementById('btn-submit-request').disabled = false;
            }
        }

    </script>
</body>
</html>